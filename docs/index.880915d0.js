/* @license
 * RAMS <https://jacobxperez.github.io/rams/>
 * Copyright (C) 2025 Jacob Perez <jacobxperez@gmx.com>
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
-----------------------------------------------------------------------------*/
class t{constructor(t,e,n={}){this.validate=Array.isArray(t)?t:[t],this.initialValue=e,this.value=null,this.pending=!1,this.lastError=null,this.label=n.label||"Value",this.listeners=new Set,this.errorListeners=new Set,arguments.length>=2&&this.set(e)}async runValidation(t){for(const e of this.validate){const n="string"==typeof e?"type":"custom",r="function"==typeof e?e.name||"anonymous":e;try{if("type"===n){if(typeof t!==e)throw new TypeError(`${this.label} must be of type '${e}', got '${typeof t}'`)}else{const n=e(t),r=n instanceof Promise?await n:n;if(!0!==r&&void 0!==r){const t="string"==typeof r?`${this.label} ${r}`:`${this.label} failed validation`;throw new TypeError(t)}}}catch(e){throw this.lastError={message:e.message,type:n,source:r,value:t,timestamp:Date.now()},this.emitError(this.lastError),e}}return t}set(t){this.lastError=null,this.pending=!0;if(this.validate.some((e=>{if("function"!=typeof e)return!1;try{return e(t)instanceof Promise}catch{return!1}})))return this._setAsync(t);try{for(const e of this.validate)if("string"==typeof e){if(typeof t!==e)throw new TypeError(`${this.label} must be of type '${e}', got '${typeof t}'`)}else{const n=e(t);if(!0!==n&&void 0!==n){const t="string"==typeof n?`${this.label} ${n}`:`${this.label} failed validation`;throw new TypeError(t)}}return this.value=t,this.pending=!1,this.emit(t),!0}catch(e){throw this.pending=!1,this.lastError={message:e.message,type:"string"==typeof validator?"type":"custom",source:validator,value:t,timestamp:Date.now()},this.emitError(this.lastError),e}}async _setAsync(t){return this.pending=!0,this.lastError=null,this.runValidation(t).then((t=>(this.value=t,this.pending=!1,this.emit(t),!0))).catch((t=>{throw this.pending=!1,console.error("[DataManager]",t.message),t}))}async validate(){this.pending=!0,this.lastError=null;try{return await this.runValidation(this.value),this.pending=!1,!0}catch{return this.pending=!1,!1}}get(){return"object"==typeof globalThis.currentEffect&&globalThis.currentEffect.deps.add(this),this.value}freeze(){return null!==this.value&&"object"==typeof this.value&&(this.value=freezeDeep(this.value)),this}unfreeze(){return null!==this.value&&"object"==typeof this.value&&(this.value=unfreezeDeep(this.value)),this}getError(){return this.lastError}getErrorReport(){if(!this.lastError)return null;const{message:t,type:e,source:n,value:r,timestamp:i}=this.lastError;return{label:this.label,message:t,type:e,source:n,value:r,timestamp:new Date(i).toLocaleString(),rawTimestamp:i}}isValid(){return null===this.lastError}isPending(){return this.pending}isDirty(){return this.value!==this.initialValue}reset(){this.set(this.initialValue)}onChange(t){return"function"==typeof t&&this.listeners.add(t),()=>this.listeners.delete(t)}onError(t){return"function"==typeof t&&this.errorListeners.add(t),()=>this.errorListeners.delete(t)}emit(t){if(this.listeners.forEach((e=>e(t))),this._effectListeners)for(const t of this._effectListeners)t()}emitError(t){this.errorListeners.forEach((e=>e(t)))}}const e=(...t)=>e=>!!t.some((t=>e instanceof t)),n=t=>e=>!!(void 0===e||t&&t(e)),r=(...t)=>e=>!!t.includes(typeof e),i=t=>!!e(Element,Document,DocumentFragment)(t)||(console.error("Must be a instance of Element, Document, DocumentFragment but received",typeof t),!1),s=t=>!(!r("string")(t)||""===t.trim()),o=t=>!!r("string")(t),a=(...t)=>(...e)=>t.length===e.length&&t.every(((t,n)=>t(e[n]))),l=(t,e)=>a(i,s)(t,e),c=new t(i),d=new t(s),u=new t(n(o)),h=new t(n(o));function f(t,e){return e?`[data-${t}="${e}"]`:`[data-${t}]`}const m=t=>(e,n)=>{if(l(t,e)){if(!t.hasAttribute(`data-${e}`))return!1;if(null===n)return!0;if(!o(n)&&null!==n)return!1;const r=t.getAttribute(`data-${e}`);return!!r&&r.trim().split(/\s+/).includes(n)}return!1},p=t=>(e,n)=>(c.set(t),d.set(e),u.set(n),c.get().closest(f(d.get(),u.get()))),g=t=>(e,n)=>r=>{if(c.set(t),d.set(e),u.set(n),h.set(r),c.isValid()&&d.isValid()&&u.set(n)&&h.set(r)){const i=t.getAttribute(`data-${e}`)===n?r:n;return t.setAttribute(`data-${e}`,i),i}return!1},y=(...t)=>{const e=new Set,n=new Set(["pop","tooltip",...t]);function r(){e.forEach((t=>{n.has(t.dataset.toggle)&&m(t)("state","active")&&g(t)("state","active")("inactive")}))}function i(t){const e=p(t)("dropbox"),n=m(t)("state","active");e||n||r(),g(t)("state","active")("inactive")}document.addEventListener("click",(t=>{const n=p(t.target)("toggle");if(n){if(n){if(e.has(n))return;e.add(n),n.addEventListener("click",(t=>{i(n),t.stopPropagation()}),!0),i(n)}else r();t.stopPropagation()}else r()}))};function E(e){const n={};for(const r in e){const{validate:i,initial:s,label:o}=e[r];n[r]=new t(i,s,{label:o})}return{fields:n,async validateAll(){let t=!0;for(const e in n){await n[e].validate()||(t=!1)}return t},isValid:()=>Object.values(n).every((t=>t.isValid())),getErrorReport(){const t={};for(const e in n){const r=n[e].getErrorReport();r&&(t[e]=r)}return Object.keys(t).length>0?t:null},resetAll(){for(const t of Object.values(n))t.reset()},getValues(){const t={};for(const e in n)t[e]=n[e].get();return t},setValues(t={}){for(const e in t)n[e]&&n[e].set(t[e])},getMeta(){const t={};for(const e in n){const r=n[e];t[e]={isValid:r.isValid(),isDirty:r.isDirty(),isPending:r.isPending(),error:r.getError(),value:r.get(),label:r.label}}return t}}}const v=new class{#t=!1;#e=null;constructor(){this.createEffect=this.createEffect.bind(this),this.data=this.data.bind(this),this.schema=this.schema.bind(this),this.toggle=y,this.#n()}#n(){this.#t||(this.#e={deps:new Set},this.#t=!0)}data(e,n,r={}){const i=new t(e,n,r);return i.get=()=>(this.#e&&this.#e.deps.add(i),i.value),i}schema(t){const e=E(t);for(const t of Object.values(e.fields)){const e=t.get.bind(t);t.get=()=>(this.#e&&this.#e.deps.add(t),e())}return e}createEffect(t,e={}){const n=new Set,r=[],i=()=>{for(const t of n)t._effectListeners?.delete(i);n.clear(),this.#e={deps:n};const e=t();this.#e=null;for(const t of n)t._effectListeners||(t._effectListeners=new Set),t._effectListeners.add(i);r.forEach((t=>t())),r.length=0,"function"==typeof e&&r.push(e)};return e.lazy||i(),{stop(){for(const t of n)t._effectListeners?.delete(i);r.forEach((t=>t()))}}}clear(){this.#e=null,this.#t=!1}},w=()=>{const t=document.getElementById("aside"),e=document.getElementById("content");if("post"===meta.type){const n=e.querySelectorAll("h1, h2, h3, h4, h5, h6"),r='\n                <ul id=\'contents\' data-display="small-none">\n                    <li>\n                        <p><strong>Contents</strong></p>\n                    </li>\n                </ul>\n    \n                <ul data-display="small" data-box="border">\n                    <li>\n                        <a data-anchor data-flex data-toggle>\n                            <strong data-item="grow">Contents</strong>\n                            <span data-icon="&#xe043;"></span>\n                        </a>\n    \n                        <ul id=\'contentsDropdown\' data-dropbox>\n                        </ul>\n                    </li>\n                </ul>';t.insertAdjacentHTML("beforeend",r),n.forEach(((t,e)=>{t.setAttribute("id",`${e}`);const n=t.innerText,r=`<li><a href="#${e}">${n}</a></li>`;document.getElementById("contents").insertAdjacentHTML("beforeend",r);const i=`<li><a href="#${e}" data-anchor="menu">${n}</a></li>`;document.getElementById("contentsDropdown").insertAdjacentHTML("beforeend",i)}))}},b={_string(t,e){const n=t.trim(),r=document.querySelector(e);r?r.insertAdjacentHTML("beforeend",n):console.error(`Error: Target element "${e}" not found.`)},_append(t,e,n){if(!t||!e||!n)return void console.error("Error: Invalid arguments in _append().");const r=t.querySelector(e);if(!r)return void console.error(`Error: Template "${e}" not found.`);const i=r.content.cloneNode(!0),s=document.querySelector(n);s?s.appendChild(i):console.error(`Error: Target element "${n}" not found.`)},parser(t,e="text/html"){try{const n=(new DOMParser).parseFromString(t,e);if(!n)throw new Error("Parsing resulted in a null document.");return n}catch(t){return console.error(`Error parsing string: ${t.message}`),null}},create(t,e,n="body"){if("string"!=typeof t||!e)return console.error("Error: Invalid HTML string or missing ID."),null;const r=document.createElement("template");r.innerHTML=t.trim(),r.setAttribute("id",e);const i=document.querySelector(n);return i?(i.appendChild(r),r):(console.error(`Error: Parent element "${n}" not found.`),null)},async string(t,e){try{await new Promise(((e,n)=>{"string"!=typeof t?n("Error: Source is not a string."):e()})),this._string(t,e)}catch(t){return console.error(t)}},async append(t,e){try{await new Promise(((e,n)=>{t||n("Error: Template selector is required."),e()})),this._append(document,t,e)}catch(t){return console.error(t)}},async fetch(t,e=null){try{const n=await fetch(t);if(!n.ok)throw new Error(`HTTP Error: ${n.status}`);const r=await n.text(),i=this.parser(r);if(!i)return;if(e){const t=i.querySelector(e);t&&!document.getElementById(t.id)?document.body.appendChild(t):console.warn(`Warning: No new template found for "${e}".`)}else i.querySelectorAll("template").forEach((t=>{document.getElementById(t.id)||document.body.appendChild(t)}))}catch(t){console.error(`Fetch error: ${t.message}`)}},removeAll(){document.querySelectorAll("template").forEach((t=>t.remove()))}};document.addEventListener("DOMContentLoaded",(()=>{""===meta.title?meta.title="<h1>RAMS</h1>":meta.title=`<h1>${meta.title}</h1>`;let t,e=`\n        <div id="header" data-container>\n            ${meta.title}\n        </div>\n        `,n='\n        <div data-container data-grid="main">\n            <aside id="aside" data-column="large-3 medium-3 small-4"></aside>\n            <article id="content" data-column="large-9 medium-9 small-4"></article>\n        </div>\n        ';"fullPage"===meta.type&&(n='\n        <div id="content" data-container data-grid="main"></div>\n        '),t="localhost"===location.hostname||"127.0.0.1"===location.hostname?window.location.origin+"/templates/index.59811f9a.html":window.location.origin+"/rams/templates/index.19081ad0.html",b.string(`\n        <nav data-navbar="top"></nav>\n        <header data-section="header">\n            ${e}\n        </header>\n        <main data-section="main">\n            ${n}\n        </main>\n        <footer data-section="footer"></footer>\n        `,"body").then((()=>b.append("#headerTemplate","#header"))).then((()=>b.append("#contentTemplate","#content"))).then((()=>w())).then((()=>b.fetch(t))).then((()=>{b.append("#navTemplate","nav"),b.append("#footerTemplate","body > footer")})).finally((()=>b.removeAll())),v.toggle()}));